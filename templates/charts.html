{% extends "base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto p-6 space-y-8">

  <!-- ================= HEADER ================= -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">Income & Expense Analysis</h1>
    <p class="text-gray-500 text-lg">Visualize your financial activity by category</p>
  </div>

  <!-- ================= FILTER FORM ================= -->
  <form method="POST" class="flex flex-wrap justify-center items-end gap-4 mb-10">
    <div class="flex flex-col">
      <label class="text-sm font-semibold text-gray-700 mb-1">Start Date</label>
      <input type="date" name="start_date" value="{{ start_date or '' }}"
        class="border border-gray-300 p-2 rounded w-44 focus:outline-none focus:ring-2 focus:ring-blue-400" />
    </div>

    <div class="flex flex-col">
      <label class="text-sm font-semibold text-gray-700 mb-1">End Date</label>
      <input type="date" name="end_date" value="{{ end_date or '' }}"
        class="border border-gray-300 p-2 rounded w-44 focus:outline-none focus:ring-2 focus:ring-blue-400" />
    </div>

    <button type="submit"
      class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded shadow-md transition transform hover:scale-105">
      Filter
    </button>

    <a href="{{ url_for('charts') }}"
      class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded shadow-md transition transform hover:scale-105 flex items-center justify-center">
      Reset
    </a>
  </form>

  <!-- ================= CHART CARDS ================= -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- INCOME CHART -->
    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition transform hover:scale-105">
      <h2 class="text-center text-xl font-semibold mb-4 text-green-600">Income by Category</h2>
      <canvas id="incomeChart" class="rounded-lg"></canvas>
    </div>

    <!-- EXPENSE CHART -->
    <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-2xl transition transform hover:scale-105">
      <h2 class="text-center text-xl font-semibold mb-4 text-red-600">Expense by Category</h2>
      <canvas id="expenseChart" class="rounded-lg"></canvas>
    </div>

  </div>

  <!-- ================= TOTALS SUMMARY ================= -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mt-10">
    <div class="bg-green-50 p-6 rounded-xl shadow-lg border-l-4 border-green-500 text-center transition hover:shadow-2xl">
      <h3 class="text-gray-700 font-semibold mb-2">Total Income</h3>
      <p class="text-3xl font-bold text-green-700">{{ total_income | default(0) }}</p>
    </div>
    <div class="bg-red-50 p-6 rounded-xl shadow-lg border-l-4 border-red-500 text-center transition hover:shadow-2xl">
      <h3 class="text-gray-700 font-semibold mb-2">Total Expense</h3>
      <p class="text-3xl font-bold text-red-700">{{ total_expense | default(0) }}</p>
    </div>
    <div class="bg-blue-50 p-6 rounded-xl shadow-lg border-l-4 border-blue-500 text-center transition hover:shadow-2xl">
      <h3 class="text-gray-700 font-semibold mb-2">Balance</h3>
      <p class="text-3xl font-bold text-blue-700">{{ balance | default(0) }}</p>
    </div>
  </div>

  <!-- ================= BACK BUTTON ================= -->
  <div class="text-center mt-8">
    <a href="{{ url_for('dashboard') }}"
      class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded shadow-md transition transform hover:scale-105">
      Back to Dashboard
    </a>
  </div>
</div>

<!-- ================= CHART.JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ================= COLOR FUNCTIONS =================
  function getIncomeColor(amount) {
    if (amount > 2000000) return "#166534"; // dark green
    if (amount > 300000) return "#22c55e";  // green
    return "#bbf7d0";                        // light green
  }

  function getExpenseColor(amount) {
    if (amount > 2000000) return "#7f1d1d"; // dark red
    if (amount > 300000) return "#ef4444";  // red
    return "#fecaca";                        // light red
  }

  // ================= INCOME BAR CHART =================
  const incomeLabels = {{ income_labels | safe }};
  const incomeValues = {{ income_values | safe }};
  const incomeColors = incomeValues.map(v => getIncomeColor(v));

  new Chart(document.getElementById("incomeChart"), {
    type: "bar",
    data: {
      labels: incomeLabels,
      datasets: [{
        label: "Income",
        data: incomeValues,
        backgroundColor: incomeColors,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `Amount: ${ctx.raw.toLocaleString()} MMK`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: value => value.toLocaleString() },
          grid: { color: "#e5e7eb" }
        },
        x: { grid: { display: false } }
      }
    }
  });

  // ================= EXPENSE BAR CHART =================
  const expenseLabels = {{ expense_labels | safe }};
  const expenseValues = {{ expense_values | safe }};
  const expenseColors = expenseValues.map(v => getExpenseColor(v));

  new Chart(document.getElementById("expenseChart"), {
    type: "bar",
    data: {
      labels: expenseLabels,
      datasets: [{
        label: "Expense",
        data: expenseValues,
        backgroundColor: expenseColors,
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `Amount: ${ctx.raw.toLocaleString()} MMK`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: value => value.toLocaleString() },
          grid: { color: "#e5e7eb" }
        },
        x: { grid: { display: false } }
      }
    }
  });
</script>

{% endblock %}
